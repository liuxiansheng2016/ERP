<!doctype html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Quebec</title>
  <meta name="description" content="Quebec">
  <meta name="keywords" content="dashboard">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <link rel="icon" type="image/png" href="assets/i/favicon.png">
  <link rel="apple-touch-icon-precomposed" href="assets/i/app-icon72x72@2x.png">
  <meta name="apple-mobile-web-app-title" content="Amaze UI" />
  <link rel="stylesheet" href="assets/css/amazeui.min.css"/>
  <link rel="stylesheet" href="assets/css/admin.css">

  <style type="text/css">
    .am-form-group {
        margin-bottom: 0.5rem;
    }
    .op-btn {
      border:0px;
      padding-left:10px;
      padding-right:10px;
      padding-top:5px;
      padding-bottom:5px;
    }

    .op-msg {
      color: red;
      font-size: 13px;
      margin-left: 15px;
    }

    .single-price-label {
      font-size: 14px;
      font-weight: bold;
      padding-top: 5px;
    }
    .single-price {
      color: #FF771D;
      font-size: 20px;
    }

    .total-price {
      color: #FF771D;
      font-size: 20px;
    }

    .single-soft-price{
      color: #FF771D;
      font-size: 20px;
    }
  </style>
</head>
<body>
<!--[if lte IE 9]>
<p class="browsehappy">你正在使用<strong>过时</strong>的浏览器，Amaze UI 暂不支持。 请 <a href="http://browsehappy.com/" target="_blank">升级浏览器</a>
  以获得更好的体验！</p>
<![endif]-->

<!--[if lt IE 9]>
<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
<script src="assets/js/amazeui.ie8polyfill.min.js"></script>
<![endif]-->

<!--[if (gte IE 9)|!(IE)]><!-->
<script src="assets/js/jquery.min.js"></script>
<!--<![endif]-->
<script src="assets/js/amazeui.min.js"></script>
<script src="assets/js/app.js"></script>
<script src="assets/js/general.js"></script>
<script src="http://cdn.hcharts.cn/highcharts/highcharts.js"></script>

<script type="text/javascript">

  var authToken = sessionStorage.getItem("X-AUTH-TOKEN");
  
  $(document).ready(function(){

    $("#item_list_link").click(function(e){
      sessionStorage.removeItem("orderId");
      window.location.href = "item-list.html";
    });

    initCategories();
    initMaterials();
    refreshSinglePrice();

    initSofts();
    initCustomers();
  });

  var categories = null;
  var selectedCategory = -1;
  var selectedMaterial = -1;

  

  function initCategories(){
    var requestUrl = SERVER_DOMAIN + "/price/categories";

    $.ajax({
      type: "GET",                                         
      url: requestUrl,
      dataType: "json",
      headers: {'X-AUTH-TOKEN': authToken},
      success: function (result) {  
        categories = result;     

        $.each(result, function(i,val){  
          $("#select-category").append("<option value='"+val.id+"'>"+val.name+"</option>");
        });

        $("#select-category").on('change', function() {
           selectedCategory = $(this).find('option').eq(this.selectedIndex).val();
           changeCategory();
        });
      },
      error: function(e) {
        $("#errormsg").html("获取数据错误！");
      }
    }); 
  }

  function initMaterials(){
    var requestUrl = SERVER_DOMAIN + "/price/materials?material_type=1";

    $.ajax({
      type: "GET",                                         
      url: requestUrl,
      dataType: "json",
      headers: {'X-AUTH-TOKEN': authToken},
      success: function (result) {                    
        $.each(result, function(i,val){  
          $("#select-material").append("<option value='"+val.id+"'>"+val.name+"</option>");
        });

        $("#select-material").on('change', function() {
           selectedMaterial = $(this).find('option').eq(this.selectedIndex).val();
        });
      },
      error: function(e) {
        $("#errormsg").html("获取数据错误！");
      }
    }); 
  }

  var _categories = ["床","床头柜","衣柜","沙发","茶几","电视柜/吊柜","书桌/梳妆台","边几","单门立柜","酒柜/书柜/书架/鞋柜","餐桌","圆桌","斗柜","餐椅"];
  var _materials = ["白蜡木","柚木","红橡木/榆木","橡胶木"];

  var seq = 1;
  var singleName = "";
  var singlePic = "";
  var singleDim = "";
  var singlePrice = 0;
  var singleCategoryDetailId = 0;
  var cat = "";
  var extraPrice = 0;
  var custRate = 1;
  var isPure = 0;
  var pureRate = 0;
  var finalPrice = 0;
  var _grandTotalPriceOriginal = 0;
  var _grandTotalPriceActual = 0;

  function changeCategory(){
    resetExtra();
    resetDim();
    
    // 2-床头柜，4-沙发，5-茶几，6-电视柜，9-单门立柜，10-酒柜/书柜/书架/鞋柜，14-餐椅
    if (selectedCategory == 2 || selectedCategory == 4 || selectedCategory == 5 || selectedCategory == 6 || selectedCategory == 9 || selectedCategory == 10 || selectedCategory == 12 || selectedCategory == 14) {
      $.each(categories, function(i,val){  
        if (val.id == selectedCategory){
            cat = val;
            updateMaterial();
        }
      });
    }
    // 床
    else if (selectedCategory == 1) {
      $.each(categories, function(i,val){  
        if (val.id == selectedCategory){
          cat = val;
          updateMaterial();
        }
        
      });

      $("#div-extra-bed").show();
    }
    // 梳妆台/书桌
    else if (selectedCategory == 7) {
      $.each(categories, function(i,val){  
        if (val.id == selectedCategory){
            cat = val;
            updateMaterial();
        }
      });
      $("#div-extra-desk").show();
    }
    // 11-餐桌
    else if (selectedCategory == 11) {
      $.each(categories, function(i,val){  
        if (val.id == selectedCategory){
          cat = val;
          updateMaterial();
        }
      });
      $("#div-extra-dinning-table").show();
    }
    // 8-边几
    else if (selectedCategory == 8) {
      $.each(categories, function(i,val){  
        if (val.id == selectedCategory){
          cat = val;
          updateMaterial();
        }
      });
      $("#div-extra-side-table").show();
    }
    // 3-衣柜
    else if (selectedCategory == 3) {
      $.each(categories, function(i,val){  
        if (val.id == selectedCategory){
          cat = val;
          updateMaterial();
        }
      });
      $("#div-extra-wardrobe").show();
    }
    // 13-斗柜
    else if (selectedCategory == 13) {
      $.each(categories, function(i,val){  
        if (val.id == selectedCategory){
          cat = val;
          updateMaterial();
        }
      });
      $("#div-extra-cabinet").show();
    }

    refreshSinglePrice();
  }

  function updateMaterial(){
    $("#div-category-detail").empty();
    $.each(cat.category_details, function(j, cd){  
      if (cd.material_id == selectedMaterial) {
        var rdoCd = '<label class="am-radio-inline"><input type="radio" name="rdo-category-detail" value="'+cd.id+'" price="'+cd.base_price+'"';
        if (cd.is_default == 1) {
          rdoCd += (' checked');
          singleCategoryDetailId = cd.id;
          singlePrice = cd.base_price;
          pureRate = cd.pure_price_inc_pct / 100;
          
          updateDim(cd);
          updateDimChange(cd);
        }
        rdoCd += ('> '+ cd.name+'</label>');
        $("#div-category-detail").append(rdoCd);
      }
    });

    $("input[name='rdo-category-detail']").change(function(e){
      singleCategoryDetailId = $('input[name="rdo-category-detail"]:checked ').val();
      singlePrice = parseInt($('input[name="rdo-category-detail"]:checked ').attr("price"));
      refreshSinglePrice();

      $.each(cat.category_details, function(j, cd){
        if (cd.id == singleCategoryDetailId){
          pureRate = cd.pure_price_inc_pct / 100;
          
          updateDim(cd);
          updateDimChange(cd);
        }
      });
      
    });

    refreshSinglePrice();
    addExtra(cat.id);
  }

  function updateDim(cd){
    $("#input-w").val(cd.width);
    $("#input-h").val(cd.height);
    $("#input-d").val(cd.depth);
  }

  function updateDimChange(cd){
    $("#input-"+cd.dim_change).attr("disabled", false);

    // 衣柜特殊处理
    if (cd.cid == 3) {
      $("#input-h").attr("disabled", false);
      $("#input-w").blur(function(e){
        var currentDimW = $("#input-w").val();
        var currentDimH = $("#input-h").val();
        
        $.each(cd.price_strategies, function(i, cds){
          if (currentDimW <= cds.max_unit && currentDimW > cds.min_unit){
            var deltaPrice = (currentDimW * currentDimH / 1000000) / cds.unit * cds.unit_price;
            singlePrice = deltaPrice;
            refreshSinglePrice();
          }
        });
        addExtra(3);
      });
      $("#input-h").blur(function(e){
        var currentDimW = $("#input-w").val();
        var currentDimH = $("#input-h").val();
        
        $.each(cd.price_strategies, function(i, cds){
          if (currentDimW <= cds.max_unit && currentDimW > cds.min_unit){
            var deltaPrice = (currentDimW * currentDimH / 1000000) / cds.unit * cds.unit_price;
            singlePrice = deltaPrice;
            refreshSinglePrice();
          }
        });
        addExtra(3);
      });

    } else {
      $("#input-"+cd.dim_change).blur(function(e){
      var currentDimX = $(this).val();
      
      $.each(cd.price_strategies, function(i, cds){
        if (currentDimX <= cds.max_unit && currentDimX > cds.min_unit){
          var baseDimX = getBaseDimX(cd);
          console.log('unit_price: ' + cds.unit_price);
          var deltaPrice = (currentDimX - baseDimX) / cds.unit * cds.unit_price;
          singlePrice = cd.base_price + deltaPrice;
          
          refreshSinglePrice();
        }
      });
    });
    }

    
  }

  function getBaseDimX(cd){
    if (cd.dim_change == 'w')
      return cd.width;
    else if (cd.dim_change == 'h')
      return cd.height;
    else if (cd.dim_change == 'd')
      return cd.depth;
  }

  

  function refreshSinglePrice(){
    if (isPure == 1) {
      finalPrice = parseInt((singlePrice + extraPrice) * custRate * (1 + pureRate));
      $(".single-price").text("￥"+parseInt((singlePrice + extraPrice) * custRate * (1 + pureRate)));
    } else {
      finalPrice = parseInt((singlePrice + extraPrice) * custRate);
      $(".single-price").text("￥"+parseInt((singlePrice + extraPrice) * custRate));
    }
    
  }

  function updatePrice(){
    custRate = $('[name="rdo-customization"]').filter(':checked').val();
    refreshSinglePrice();
  }

  function changePure(){
    isPure = $('[name="rdo-pure"]').filter(':checked').val();
    refreshSinglePrice();
  }

  function resetDim() {
    $("#input-w").attr("disabled", true);
    $("#input-h").attr("disabled", true);
    $("#input-d").attr("disabled", true);
  }

  function resetExtra(){
    $("#div-extra-bed").hide();
    $("#div-extra-desk").hide();
    $("#div-extra-dinning-table").hide();
    $("#div-extra-side-table").hide();
    $("#div-extra-wardrobe").hide();
    $("#div-extra-cabinet").hide();
  }

  function addExtra(catId){
    // 床
    if (catId == 1) {
      extraPrice = 0;
      $('[name="cb-extra-bed"]').filter(':checked').each(function(){ 
        extraPrice += parseInt($(this).val());
      });
      refreshSinglePrice();
    }
    // 梳妆台/书桌
    else if (catId == 7) {
      extraPrice = 0;
      $('[name="cb-extra-desk"]').filter(':checked').each(function(){ 
        var deskSidePrices = $(this).val().split("|");
        extraPrice += parseInt(deskSidePrices[selectedMaterial-1]);
      });
      refreshSinglePrice();
    }
    // 餐桌
    else if (catId == 11) {
      extraPrice = 0;
      $('[name="cb-extra-dinning-table"]').filter(':checked').each(function(){ 
        extraPrice += parseInt($(this).val());
      });
      refreshSinglePrice();
    }
    // 边几
    else if (catId == 8) {
      extraPrice = 0;
      $('[name="cb-extra-side-table"]').filter(':checked').each(function(){ 
        var deskSidePrices = $(this).val().split("|");
        extraPrice += parseInt(deskSidePrices[selectedMaterial-1]);
      });
      refreshSinglePrice();
    }
    // 衣柜
    else if (catId == 3) {
      extraPrice = 0;
      $('[name="cb-extra-wardrobe"]').filter(':checked').each(function(){ 
        var currentDimW = $("#input-w").val();
        var currentDimH = $("#input-h").val();
        var area = (currentDimW * currentDimH / 1000000);
        extraPrice += parseInt(500 * area);
      });
      refreshSinglePrice();
    }
    // 斗柜
    else if (catId == 13) {
      extraPrice = 0;
      var bucketNo = $("#cb-extra-cabinet").val();
      console.log(bucketNo + "个斗");
      var bucketPrices = [550, 800, 650, 320];
      extraPrice += parseInt(bucketPrices[selectedMaterial-1] * bucketNo);
      console.log(extraPrice);
      refreshSinglePrice();
    }
  }

  // Above is single price calculation.
  // ----------------------------------------------------------------------
  // Below is cart operation part.

  function add2cart(){
    var dimW = $("#input-w").val();
    var dimH = $("#input-h").val();
    var dimD = $("#input-d").val();

    $("#table-goods").append("<tr id='"+seq+"'>" + 
      "<td data='123'>&nbsp;</td>" + 
      "<td data='"+seq+"' style='font-size:12px'>"+seq+"</td>" + 
      "<td data='"+_categories[selectedCategory-1]+"'><input type='text' style='width:120px;font-size:12px' value='"+_categories[selectedCategory-1]+"'/></td>" +
      "<td>"+"<input type='text' style='width:40px;font-size:12px' value='"+dimW+"' />*"+"<input type='text' style='width:40px;font-size:12px' value='"+dimH+"' />*"+"<input type='text' style='width:40px;font-size:12px' value='"+dimD+"' />"+"</td>" + 
      "<td>"+_materials[selectedMaterial-1]+"</td>" +
      "<td>"+"<input type='text' style='width:50px;font-size:12px' />"+"</td>" + 
      "<td style='font-size:12px;line-height:2'>￥"+finalPrice+"</td>" + 
      "<td><span id='sp_quantity'><input type='text' style='width:25px;font-size:12px' value='1' /></span></td>" + 
      "<td style='font-size:12px;line-height:2'><span id='sp_line_total'><input type='text' style='width:50px;font-size:12px' value='￥"+finalPrice+"' /></span></td>" + 
      "<td>"+"<span id='sp_discount'><input type='text' style='width:40px;font-size:12px' value='1' /></span>"+"</td>" + 
      "<td>"+"<input type='text' style='width:80px;font-size:12px'/>"+"</td>" + 
      "<td>"+"<input type='text' style='width:150px;font-size:12px' />"+"</td>" + 
      "<td><span id='sp_remove'><a seq=''><i class='am-icon-minus-circle' style='color:red'></i></a></span></td>" + 
      "</tr>");

    seq++;
    updateGrandTotal();

    $("#add-result").text("物品添加成功！");
    setTimeout("resetMsg()", 1000)

    $("#sp_remove a").click(function(e){
      var tr2remove = $(this).parent().parent().parent();
      tr2remove.remove();
      updateGrandTotal();
    });

    $("#sp_quantity input").change(function(e){
      var quantity = $(this).val();
      var unitPriceStr = $(this).parent().parent().parent().find("td").eq(6).text();
      var unitPrice = parseInt(unitPriceStr.substring(1));
      var lineTotal = unitPrice * quantity;
      $(this).parent().parent().parent().find("td").eq(8).find("input").val("￥"+lineTotal);

      updateGrandTotal();
    });

    $("#sp_discount input").change(function(e){
      // var discount = $(this).val();
      // var linePriceStr = $(this).parent().parent().parent().find("td").eq(8).find("input").val();
      // var linePrice = parseInt(linePriceStr.substring(1));
      // var lineTotal = linePrice * discount;
      // $(this).parent().parent().parent().find("td").eq(8).find("input").val("￥"+lineTotal);

      updateGrandTotal();
    });

    $("#sp_line_total input").change(function(e){
      updateGrandTotal();
    });
  }

  function resetMsg(){
    $("#add-result").text("");
  }

  function updateGrandTotal(){
    var lines = $("#table-goods tr");
    var grandTotal = 0;
    var grandTotalActual = 0;
    
    for (var i = 1; i < lines.length; i++){
      var lineTotalStr = $("#table-goods").find("tr").eq(i).find("td").eq(8).find("input").val();
      var lineTotal = parseInt(lineTotalStr.substring(1));
      grandTotal += lineTotal;

      var discount = $("#table-goods").find("tr").eq(i).find("td").eq(9).find("input").val();
      grandTotalActual += lineTotal * discount;
    }

    _grandTotalPriceOriginal = grandTotal;
    $("#grand_total_original").text("￥"+_grandTotalPriceOriginal);

    _grandTotalPriceActual = grandTotalActual;
    $("#grand_total_actual").val(_grandTotalPriceActual);
  }


  function export2excel(){
    var obj = [];
    var items = new Array();
    var lines = $("#table-goods tr");
    
    for (var i = 1; i < lines.length; i++){
      var line = lines[i];
      var item = {};
      item["seq"] = $("#table-goods").find("tr").eq(i).find("td").eq(1).text();
      item["title"] = $("#table-goods").find("tr").eq(i).find("td").eq(2).find("input").val();
      item["dim"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(0).val()+"*"+$("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(1).val()+"*"+$("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(2).val();
      item["material"] = $("#table-goods").find("tr").eq(i).find("td").eq(4).text();
      item["accessory"] = $("#table-goods").find("tr").eq(i).find("td").eq(5).find("input").val();
      item["unit_price"] = $("#table-goods").find("tr").eq(i).find("td").eq(6).text();
      item["quantity"] = $("#table-goods").find("tr").eq(i).find("td").eq(7).find("input").val();
      item["total_price"] = $("#table-goods").find("tr").eq(i).find("td").eq(8).find("input").val();
      item["color"] = $("#table-goods").find("tr").eq(i).find("td").eq(10).find("input").val();
      item["remarks"] = $("#table-goods").find("tr").eq(i).find("td").eq(11).find("input").val();
      
      items.push(item);
    }
    var dataObj = {"items": items, "grand_total_price_original": _grandTotalPriceOriginal, "grand_total_price_actual": _grandTotalPriceActual};

    $.ajax({
        type: 'POST',
        url: SERVER_DOMAIN + "/price/export",
        contentType: "application/json",
        dataType: "json",         
        headers: {'X-AUTH-TOKEN': authToken},                          
        data: JSON.stringify(dataObj),    
        success: function(r) {
          $("#add-result").html("报价单导出成功！");
          setTimeout("resetMsg()", 1000);
          window.open(r.pricing_table_url, "_blank");
        },
        error: function(r) { 
          $("#add-result").html("报价单导出失败！");
          setTimeout("resetMsg()", 1000);
        }
    });

    
  }

  function openSave(){
    $('#save_prompt').modal({
      relatedTarget: this,
      onConfirm: function(e) {
        saveProfile();
      },
      onCancel: function(e) {
        
      }
    });
  }

  function saveProfile(){
    var obj = [];
    var items = new Array();
    var lines = $("#table-goods tr");
    
    for (var i = 1; i < lines.length; i++){
      var line = lines[i];
      var item = {};
      item["seq"] = $("#table-goods").find("tr").eq(i).find("td").eq(1).text();
      item["title"] = $("#table-goods").find("tr").eq(i).find("td").eq(2).find("input").val();
      item["width"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(0).val();
      item["height"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(1).val();
      item["depth"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(2).val();
      //item["dim"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(0).val()+"*"+$("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(1).val()+"*"+$("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(2).val();
      item["material"] = $("#table-goods").find("tr").eq(i).find("td").eq(4).text();
      item["accessory"] = $("#table-goods").find("tr").eq(i).find("td").eq(5).find("input").val();
      item["unit_price"] = $("#table-goods").find("tr").eq(i).find("td").eq(6).text();
      item["quantity"] = $("#table-goods").find("tr").eq(i).find("td").eq(7).find("input").val();
      item["total_price"] = $("#table-goods").find("tr").eq(i).find("td").eq(8).find("input").val();
      item["color"] = $("#table-goods").find("tr").eq(i).find("td").eq(10).find("input").val();
      item["remarks"] = $("#table-goods").find("tr").eq(i).find("td").eq(11).find("input").val();
      
      items.push(item);
    }
    var title = $("#profile_title").val();
    var dataObj = {"items": items, "title": title};

    $.ajax({
        type: 'POST',
        url: SERVER_DOMAIN + "/price/save",
        contentType: "application/json",
        dataType: "json",         
        headers: {'X-AUTH-TOKEN': authToken},                          
        data: JSON.stringify(dataObj),    
        success: function(r) {
          $("#add-result").html("报价单保存成功！");
          setTimeout("resetMsg()", 2000);
          
        },
        error: function(r) { 
          $("#add-result").html("报价单保存失败！");
          setTimeout("resetMsg()", 2000);
        }
    });
  }

  function loadProfiles(){
    $.ajax({
      type: "GET",                                         
      url: SERVER_DOMAIN + "/price/select",
      dataType: "json",
      headers: {'X-AUTH-TOKEN': authToken},
      success: function (data) {  
        $("#sel_profile").empty();  
        $.each(data.data, function(i,val){  
          $("#sel_profile").append("<option value='"+val+"'>"+val+"</option>");
        });
      },
      error: function(e) { 
        $("#errormsg").html("没有查询到结果！");
      }
    }) 
  }

  function openLoad(){
    loadProfiles();
    $('#load_prompt').modal({
      relatedTarget: this,
      onConfirm: function(e) {
        loadProfile();
      },
      onCancel: function(e) {
        
      }
    });
  }

  function loadProfile(){
    var title = $("#sel_profile").val();
    $.ajax({
        type: "GET",                                         
        url: SERVER_DOMAIN + "/price/load?title=" + title,
        dataType: "json",
        headers: {'X-AUTH-TOKEN': authToken},
        success: function (r) {                     
          var lines = $("#table-goods tr");
          for (var i = 1; i < lines.length; i++){
            lines[i].remove();
          }

          $.each(r.data, function(i, val){
            $("#table-goods").append("<tr id='"+val.seq+"'>" + 
              "<td data='123'>&nbsp;</td>" + 
              "<td data='"+val.seq+"' style='font-size:12px'>"+val.seq+"</td>" + 
              "<td data='"+val.name+"'><input type='text' style='width:120px;font-size:12px' value='"+val.name+"'/></td>" +
              "<td>"+"<input type='text' style='width:40px;font-size:12px' value='"+val.width+"' />*"+"<input type='text' style='width:40px;font-size:12px' value='"+val.height+"' />*"+"<input type='text' style='width:40px;font-size:12px' value='"+val.depth+"' />"+"</td>" + 
              "<td>"+val.material+"</td>" +
              "<td>"+"<input type='text' style='width:50px;font-size:12px' />"+val.accessory+"</td>" + 
              "<td style='font-size:12px;line-height:2'>￥"+val.unit_price+"</td>" + 
              "<td><span id='sp_quantity'><input type='text' style='width:25px;font-size:12px' value='"+val.quantity+"' /></span></td>" + 
              "<td style='font-size:12px;line-height:2'><span id='sp_line_total'><input type='text' style='width:50px;font-size:12px' value='￥"+val.total_price+"' /></span></td>" + 
              "<td>"+"<span id='sp_discount'><input type='text' style='width:50px;font-size:12px' value='1' /></span>"+"</td>" + 
              "<td>"+"<input type='text' style='width:50px;font-size:12px' value='"+val.color+"' />"+"</td>" + 
              "<td>"+"<input type='text' style='width:150px;font-size:12px' value='"+val.remarks+"'/>"+"</td>" + 
              "<td><span id='sp_remove'><a seq=''><i class='am-icon-minus-circle' style='color:red'></i></a></span></td>" + 
              "</tr>");
          });
          updateGrandTotal();

          $("#sp_remove a").click(function(e){
            var tr2remove = $(this).parent().parent().parent();
            tr2remove.remove();
            updateGrandTotal();
          });

          $("#sp_quantity input").change(function(e){
            var quantity = $(this).val();
            var unitPriceStr = $(this).parent().parent().parent().find("td").eq(6).text();
            var unitPrice = parseInt(unitPriceStr.substring(1));
            var lineTotal = unitPrice * quantity;
            $(this).parent().parent().parent().find("td").eq(8).find("input").val("￥"+lineTotal);

            updateGrandTotal();
          });

          $("#sp_discount input").change(function(e){
            updateGrandTotal();
          });

          $("#sp_line_total input").change(function(e){
            updateGrandTotal();
          });
        },
        error: function(r) { 
          $("#add-result").html("报价单保存失败！");
          setTimeout("resetMsg()", 2000);
        }
      })
  }



  var softs = null;
  var selectedSoftCategory = -1;
  var selectedSoftId = -1;
  var selectedSoftTag = -1;

  var singleSoftPrice = 0;

  //类型，1-挂画，2-灯具，3-餐具，4-四件套，5-收纳盒，6-摆件，0-其他
  function initSofts(){
    var requestUrl = SERVER_DOMAIN + "/soft/select?count=10000";

    $.ajax({
      type: "GET",
      url: requestUrl,
      dataType: "json",
      headers: {'X-AUTH-TOKEN': authToken},
      success: function (result) {
        softs = result.data;

        selectedSoftCategory = softs[0].category;
        changeSoftCategory();
        refreshSoftSinglePrice();
      },
      error: function(e) {
        $("#errormsg").html("获取数据错误！");
      }
    }); 
  }

  function changeSoftCategory(){
    selectedSoftCategory = $("#select-soft-category").val();

    $("#select-soft").empty();
    $.each(softs, function(i, val){
      if (val.category == selectedSoftCategory) {
        $("#select-soft").append("<option value='"+val.id+"'>"+val.name+"</option>");
      }
    });
    resetSoftSinglePrice();
  }

  function changeSoft(){
    selectedSoftId = $("#select-soft").val();

    $.each(softs, function(i, val){
      if (val.id == selectedSoftId) {
        $("#div-soft-tag").empty();
        $.each(val.prices, function(j, price) {
          var rdoSoftPrice = '<label class="am-radio-inline"><input type="radio" name="rdo-soft-price" value="'+price.tag+'" price="'+price.price+'" >'+ price.tag+'</label>';
          $("#div-soft-tag").append(rdoSoftPrice);
        });

        $("#soft-pic").attr("src", val.main_image_url);
      }
    });

    $("input[name='rdo-soft-price']").change(function(e){
      singleSoftPrice = parseInt($('input[name="rdo-soft-price"]:checked ').attr("price"));
      refreshSoftSinglePrice();
    });

    resetSoftSinglePrice();
  }

  function refreshSoftSinglePrice(){
    $(".single-soft-price").text("￥"+singleSoftPrice);
  }

  function resetSoftSinglePrice(){
    singleSoftPrice = 0;
    refreshSoftSinglePrice();
  }

  function initCustomers(){
    $.ajax({
      type: "GET",
      url: SERVER_DOMAIN + "/customer/select?count=100000",
      dataType: "json",
      headers: {'X-AUTH-TOKEN': authToken},
      success: function (data) {
        $("#sel_customer").empty();
        $.each(data.data, function(i,val){
          $("#sel_customer").append("<option value='"+val.id+"'>"+val.name+"&nbsp;&nbsp;"+val.phone_number+"</option>");
        });
      },
      error: function(e) {
        $("#errormsg").html("没有查询到结果！");
      }
    })
  }

  function openGenerate(){
    $('#generate_prompt').modal({
      relatedTarget: this,
      onConfirm: function(e) {
        generate();
      },
      onCancel: function(e) {

      }
    });
  }

  function generate(){
    var order_name = $("#order_name").val();
    var order_desc = $("#order_desc").val();
    var due_date = $("#due_date").val();
    var order_date = $("#order_date").val();
    var settled_factory = $("input[name='radio_settled_factory']:checked").val();
    var contract_no = $("#contract_no").val();
    var customer_id = $("#sel_customer").val();

    var obj = [];
    var items = new Array();
    var lines = $("#table-goods tr");

    for (var i = 1; i < lines.length; i++){
      var line = lines[i];
      var item = {};
      item["seq"] = $("#table-goods").find("tr").eq(i).find("td").eq(1).text();
      item["title"] = $("#table-goods").find("tr").eq(i).find("td").eq(2).find("input").val();
      item["width"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(0).val();
      item["height"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(1).val();
      item["depth"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(2).val();
      //item["dim"] = $("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(0).val()+"*"+$("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(1).val()+"*"+$("#table-goods").find("tr").eq(i).find("td").eq(3).find("input").eq(2).val();
      item["material"] = $("#table-goods").find("tr").eq(i).find("td").eq(4).text();
      item["accessory"] = $("#table-goods").find("tr").eq(i).find("td").eq(5).find("input").val();
      item["unit_price"] = $("#table-goods").find("tr").eq(i).find("td").eq(6).text();
      item["quantity"] = $("#table-goods").find("tr").eq(i).find("td").eq(7).find("input").val();
      item["total_price"] = $("#table-goods").find("tr").eq(i).find("td").eq(8).find("input").val();
      item["color"] = $("#table-goods").find("tr").eq(i).find("td").eq(10).find("input").val();
      item["remarks"] = $("#table-goods").find("tr").eq(i).find("td").eq(11).find("input").val();

      items.push(item);
    }
    var dataObj = {"items": items, "order_name": order_name, "order_desc": order_desc, "due_date": due_date, "order_date": order_date, "settled_factory": settled_factory, "contract_no": contract_no, "customer_id": customer_id, "grand_total_price_actual": _grandTotalPriceActual};

    if (items.length <= 0) {
      alert("报价清单为空！");
      return;
    }

    $.ajax({
        type: 'POST',
        url: SERVER_DOMAIN + "/price/generate",
        contentType: "application/json",
        dataType: "json",
        headers: {'X-AUTH-TOKEN': authToken},
        data: JSON.stringify(dataObj),
        success: function(r) {
          $("#add-result").html("生成订单成功！");
          setTimeout("resetMsg()", 2000);

        },
        error: function(r) {
          $("#add-result").html("生成订单失败！");
          setTimeout("resetMsg()", 2000);
        }
    });
  }

  function changeGrandTotalActual(){
    _grandTotalPriceActual = $("#grand_total_actual").val();
  }
  </script>

<header class="am-topbar admin-header">
  <div class="am-topbar-brand">
    <a href="index2.html">
    <img src="assets/i/quebec_logo.jpg" class="logo"> &nbsp;<strong>Quebec</strong> <small>后台管理系统</small>
    </a>
  </div>

  <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-success am-show-sm-only" data-am-collapse="{target: '#topbar-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button>

  <div class="am-collapse am-topbar-collapse" id="topbar-collapse">
    <ul class="am-nav am-nav-pills am-topbar-nav">
      <li><a href="order-list.html">订单</a></li>
      <li id="li_customer"><a href="customer-list.html">客户</a></li>
      <li id="li_price" class="am-active"><a href="price.html">报价</a></li>
      <li id="li_dashboard"><a href="dashboard.html">报表</a></li>
    </ul>

    <ul class="am-nav am-nav-pills am-topbar-nav am-topbar-right admin-header-list">
      <li class="am-dropdown" data-am-dropdown>
        <a class="am-dropdown-toggle" data-am-dropdown-toggle href="javascript:;">
          <span class="am-icon-plus"></span> 快速新建 <span class="am-icon-caret-down"></span>
        </a>
        <ul class="am-dropdown-content">
          <li><a href="customer-create.html"><span class="am-icon-user"></span> 客户</a></li>
          <li><a href="order-create.html"><span class="am-icon-file-text"></span> 订单</a></li>
        </ul>
      </li>
      <li><a href="javascript:;"><span class="am-icon-envelope-o"></span> 收件箱 <span class="am-badge am-badge-warning">0</span></a></li>
      <li class="am-dropdown" data-am-dropdown>
        <a class="am-dropdown-toggle" data-am-dropdown-toggle href="javascript:;">
          <span class="am-icon-users"></span> <span id="sp_username"></span> <span class="am-icon-caret-down"></span>
        </a>
        <ul class="am-dropdown-content">
          <li><a href="my-info.html"><span class="am-icon-user"></span> 资料</a></li>
          <li><a href="#"><span class="am-icon-cog"></span> 设置</a></li>
          <li><a href="javascript:logout();"><span class="am-icon-power-off"></span> 退出</a></li>
        </ul>
      </li>
      
    </ul>
  </div>
</header>

<div class="am-cf admin-main">
  <!-- sidebar start -->
  <!-- <div class="admin-sidebar am-offcanvas" id="admin-offcanvas">
    <div class="am-offcanvas-bar admin-offcanvas-bar">
      <ul class="am-list admin-sidebar-list">
        <li><a href="price.html"><span class="am-icon-home"></span> 报价系统</a></li>
      </ul>

    </div>
  </div>  -->
  <!-- sidebar end -->

  <!-- content start -->
  <div class="admin-content">
    <div class="am-u-sm-4">
      <div class="am-tabs am-margin" data-am-tabs>
        <ul class="am-tabs-nav am-nav am-nav-tabs">
          <li class="am-active"><a href="#tab1">非标</a></li>
          <li><a href="#tab2">标品</a></li>
          <li><a href="#tab3">软配</a></li>

          <div style="width:100%;text-align:right">
            <button class="am-btn-s am-btn-primary op-btn" onclick="add2cart()">增加</button>
          </div>
        </ul>

        <div class="am-tabs-bd" style="padding-bottom: 400px;">
          <div class="am-tab-panel am-fade am-in am-active am-form am-padding-horizontal-0" id="tab1">
              <div class="am-g ">
                <div class=" am-u-sm-2 am-text-right">类别</div>
                <div class=" am-u-sm-10 am-u-end">
                  <div class="am-form-group">
                      <select id="select-category" data-am-selected="{btnSize: 'sm'}">
                      </select>
                  </div>
                </div>
              </div> 

              <div class="am-g ">
                <div class=" am-u-md-2 am-text-right">材料</div>
                <div class=" am-u-md-4 am-u-end">
                  <div class="am-form-group">
                      <select id="select-material" data-am-selected="{btnSize: 'sm'}" onchange="updateMaterial()">

                      </select>
                  </div>
                </div>
              </div> 

              <div class="am-g ">
                <div class="am-u-sm-2 am-text-right">细类</div>
                <div class="am-u-sm-10 am-u-end">
                  <div class="am-form-group" id="div-category-detail">
                    
                  </div>
                </div>
              </div>

              <div class="am-g ">
                <div class="am-u-sm-2 am-text-right" style="line-height:2">尺寸</div>
                <div class="am-u-sm-10 am-u-end">
                  <div class="am-form-group" id="div-dim">
                    宽 <input type="text" id="input-w" style="width:50px;display:inline;font-size:12px;text-align:right" disabled/>mm * 
                    高 <input type="text" id="input-h" style="width:50px;display:inline;font-size:12px;text-align:right" disabled/>mm * 
                    深 <input type="text" id="input-d" style="width:50px;display:inline;font-size:12px;text-align:right" disabled/>mm
                  </div>
                </div>
              </div>

              

              <div class="am-g">
                <div class="am-u-sm-2 am-text-right">定制</div>
                <div class="am-u-sm-10 am-u-end">
                  <div class="am-form-group">
                    <label class="am-radio-inline">
                      <input type="radio" name="rdo-customization" value="0.9" data-am-ucheck onchange="updatePrice()"> 减度
                    </label>
                    <label class="am-radio-inline">
                      <input type="radio" name="rdo-customization" value="1" data-am-ucheck checked="true" onchange="updatePrice()"> 无
                    </label>
                    <label class="am-radio-inline">
                      <input type="radio" name="rdo-customization" value="1.1" data-am-ucheck onchange="updatePrice()"> 轻度
                    </label>
                    <label class="am-radio-inline">
                      <input type="radio" name="rdo-customization" value="1.3" data-am-ucheck onchange="updatePrice()"> 中度
                    </label>
                    <label class="am-radio-inline">
                      <input type="radio" name="rdo-customization" value="1.5" data-am-ucheck onchange="updatePrice()"> 重度
                    </label>
                  </div>
                </div>
              </div>

              <div class="am-g">
                <div class="am-u-sm-2 am-text-right">辅料</div>
                <div class="am-u-sm-10 am-u-end">
                  <div class="am-form-group">
                    <label class="am-radio-inline">
                      <input type="radio" name="rdo-pure" value="0" data-am-ucheck checked="true" onchange="changePure()"> 默认
                    </label>
                    <label class="am-radio-inline">
                      <input type="radio" name="rdo-pure" value="1" data-am-ucheck onchange="changePure()"> 无辅料
                    </label>
                  </div>
                </div>
              </div>

              <div class="am-g ">
                <div class="am-u-sm-2 am-text-right">其他</div>
                <div class="am-u-sm-10 am-u-end">
                  <div class="am-form-group" id="div-extra-bed" style="display:none">
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-bed" value="350" data-am-ucheck onchange="addExtra(1)"> 气压杆
                    </label>
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-bed" value="400" data-am-ucheck onchange="addExtra(1)"> 床板换橡胶木
                    </label>
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-bed" value="300" data-am-ucheck onchange="addExtra(1)"> 包布(单)
                    </label>
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-bed" value="600" data-am-ucheck onchange="addExtra(1)"> 包布(双)
                    </label>
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-bed" value="1200" data-am-ucheck onchange="addExtra(1)"> 包真皮
                    </label>
                  </div>

                  <div class="am-form-group" id="div-extra-sofa" style="display:none">
                    <span>注：沙发展厅款式及官网款式的价格为中度定制。</span>
                  </div>

                  <div class="am-form-group" id="div-extra-desk" style="display:none">
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-desk" value="750|950|850|450" data-am-ucheck onchange="addExtra(7)"> 边柜
                    </label>
                  </div>

                  <div class="am-form-group" id="div-extra-dinning-table" style="display:none">
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-dinning-table" value="400" data-am-ucheck onchange="addExtra(11)"> 可拉伸
                    </label>
                  </div>

                  <div class="am-form-group" id="div-extra-side-table" style="display:none">
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-side-table" value="450|600|550|300" data-am-ucheck onchange="addExtra(8)"> 带抽屉
                    </label>
                  </div>

                  <div class="am-form-group" id="div-extra-wardrobe" style="display:none">
                    <label class="am-checkbox-inline">
                      <input type="checkbox" name="cb-extra-wardrobe" value="500" data-am-ucheck onchange="addExtra(3)"> 辅料换橡胶木
                    </label>
                  </div>

                  <div class="am-form-group" id="div-extra-cabinet" style="display:none">
                      <input type="text" id="cb-extra-cabinet" value="5" onblur="addExtra(13)" style="width:30px;display:inline;font-size:12px"> 个斗
                  </div>
                </div>
              </div>

              <div class="am-g">
                <div class="am-u-sm-9 am-text-right single-price-label">价格</div>
                <div class="am-u-sm-3 single-price am-padding-left-0"></div>
              </div>
          </div>
          <div class="am-tab-panel am-fade am-in am-active am-form" id="tab2">

          </div>
          <div class="am-tab-panel am-fade am-in am-active am-form" id="tab3">
              <div class="am-g">
                <div class="am-u-sm-2 am-text-right">类别</div>
                <div class="am-u-sm-10 am-u-end">
                  <div class="am-form-group">
                      <!-- 类型，1-挂画，2-灯具，3-餐具，4-四件套，5-收纳盒，6-摆件，0-其他 -->
                      <select id="select-soft-category" data-am-selected="{btnSize: 'sm'}" onchange="changeSoftCategory()">
                        <option value="1">挂画</option>
                        <option value="2">灯具</option>
                        <option value="3">餐具</option>
                        <option value="4">四件套</option>
                        <option value="5">收纳盒</option>
                        <option value="6">摆件</option>
                        <option value="0">其他</option>
                      </select>
                  </div>
                </div>

                <div class="am-u-sm-2 am-text-right">名称</div>
                <div class="am-u-sm-10 am-u-end">
                  <div class="am-form-group">
                      <select id="select-soft" data-am-selected="{searchBox: 1,btnSize: 'sm',maxHeight:400}" onchange="changeSoft()">
                        
                      </select>
                  </div>
                  <div>
                    <img id="soft-pic" width="200px" src="" alt="pic" />
                  </div>
                </div>

                <div class="am-u-sm-2 am-text-right">规格</div>
                <div class="am-u-sm-10 am-u-end">
                  <div class="am-form-group" id="div-soft-tag">
                      
                  </div>
                </div>
              </div> 

              <div class="am-g">
                <div class="am-u-sm-9 am-text-right single-price-label">价格</div>
                <div class="am-u-sm-3 single-soft-price am-padding-left-0"></div>
              </div>
          </div>
        </div>

      </div>
    </div>
    <div class="am-u-sm-8 am-padding-left-0">
      <div class="am-u-sm-6" style="color:#0e90d2; margin-top:20px; margin-bottom:10px; padding-left:0px">
        报价清单
        <span id="add-result" class="op-msg"></span>
      </div>
      <div class="am-u-sm-6 am-margin-top-sm" style="text-align:right; margin-top:20px; margin-bottom:10px">
        <button class="am-btn-s op-btn" onclick="openLoad()"><i class="am-icon-folder-open-o"></i> 加载</button>
        <button class="am-btn-s op-btn" onclick="openSave()"><i class="am-icon-save"></i> 保存</button>
        <button class="am-btn-s am-btn-primary op-btn" onclick="export2excel()"><i class="am-icon-file-excel-o"></i> 导出Excel</button>
        <button class="am-btn-s am-btn-warning op-btn" onclick="openGenerate()"><i class="am-icon-list-alt"></i> 生成订单</button>
      </div>

      <div>
        <table class="am-table am-table-bd am-table-striped admin-content-table am-table-compact am-table-hover" id="table-goods">
        <th>
          <td>#</td>
          <td>名称</td>
          <td>规格</td>
          <td>主材料</td>
          <td>辅料</td>
          <td>单价</td>
          <td>数量</td>
          <td>金额</td>
          <td>折扣</td>
          <td>颜色</td>
          <td>备注</td>
          <td>&nbsp;</td>
        </th>
        
        </table>
      </div>
      <div class="am-g">
        <div class="am-u-sm-9 am-text-right single-price-label">总价</div>
        <div class="am-u-sm-3 total-price am-padding-left-0" id="grand_total_original">￥0</div>
        <div class="am-u-sm-9 am-text-right single-price-label">实际成交价</div>
        <div class="am-u-sm-3 total-price am-padding-left-0">
          ￥<input type="text" value="0" style="width:80px" id="grand_total_actual" onchange="changeGrandTotalActual()" />
        </div>
      </div>
    </div> 
  
    <div class="am-modal am-modal-prompt" tabindex="-1" id="save_prompt">
      <div class="am-modal-dialog">
        <div class="am-modal-hd"></div>
        <div class="am-modal-bd">
          请为该报价单输入一个标题
          <input type="text" class="am-modal-prompt-input" id="profile_title">
        </div>
        <div class="am-modal-footer">
          <span class="am-modal-btn" data-am-modal-cancel>取消</span>
          <span class="am-modal-btn" data-am-modal-confirm>确定</span>
        </div>
      </div>
    </div>

    <div class="am-modal am-modal-prompt" tabindex="-1" id="load_prompt">
      <div class="am-modal-dialog">
        <div class="am-modal-hd"></div>
        <div class="am-modal-bd">
          请选择报价单 <br/>
          <select data-am-selected="{searchBox: 1}" id="sel_profile">
            
          </select>
        </div>
        <div class="am-modal-footer">
          <span class="am-modal-btn" data-am-modal-cancel>取消</span>
          <span class="am-modal-btn" data-am-modal-confirm>确定</span>
        </div>
      </div>
    </div>

    <div class="am-modal am-modal-prompt" tabindex="-1" id="generate_prompt">
      <div class="am-modal-dialog am-g">
        <div class="am-modal-hd">生成订单</div>
        <div class="am-modal-bd am-u-sm-12">
          <div class="am-u-sm-2 am-text-right am-padding-horizontal-0">客户</div>
          <div class="am-u-sm-10 am-text-left">
            <select data-am-selected="{searchBox:1,maxHeight:350}" id="sel_customer">
              
            </select>
          </div>

          <div class="am-u-sm-2 am-text-right am-padding-horizontal-0">标题</div>
          <div class="am-u-sm-10 am-text-left">
            <input id="order_name" type="text" class="am-modal-prompt-input" placeholder='需包含客户姓名，方便检索，如"王先生2室2厅订单"'>
          </div>

          <div class="am-u-sm-2 am-text-right am-padding-horizontal-0">描述</div>
          <div class="am-u-sm-10  am-text-left">
            <textarea id="order_desc" class="am-modal-prompt-input" rows="4" style="font-size:14px;" placeholder="订单任何需要注意的地方，请尽量详述"></textarea>
          </div>

            <div class="am-u-sm-2 am-text-right am-padding-horizontal-0">成交日期</div>
            <div class="am-u-sm-10 am-text-left">
              <input id="order_date" type="text" class="am-modal-prompt-input" placeholder="yyyy-MM-dd">
            </div>

            <div class="am-u-sm-2 am-text-right am-padding-horizontal-0">送货时间</div>
            <div class="am-u-sm-10 am-text-left ">
              <input id="due_date" type="text" class="am-modal-prompt-input" placeholder="yyyy-MM-dd">
            </div>

            <div class="am-u-sm-2 am-text-right am-padding-horizontal-0">合同编号</div>
            <div class="am-u-sm-10 am-text-left">
              <input id="contract_no" type="text" class="am-modal-prompt-input" placeholder="合同编号（必填）">
            </div>

            <div class="am-u-sm-2 am-text-right am-padding-horizontal-0">供应商结算</div>
            <div class="am-u-sm-10 am-text-left">
              <div class="am-form-group">
                <label class="am-radio-inline">
                  <input type="radio" value="0" name="radio_settled_factory" checked> 未结
                </label>
                <label class="am-radio-inline">
                  <input type="radio" value="1" name="radio_settled_factory"> 已结
                </label>
              </div>
            </div>

            <div class="am-u-sm-12 am-padding-top-sm" style="font-size: 11px; font-weight: normal;">
              * 订单完成后请到订单管理页面添加设计文件、配送文件等。
            </div>
        </div>
        <div class="am-modal-footer">
          <span class="am-modal-btn" data-am-modal-cancel>取消</span>
          <span class="am-modal-btn" data-am-modal-confirm>确定</span>
        </div>
      </div>
    </div>
  <!-- content end -->

</div>

<a href="#" class="am-icon-btn am-icon-th-list am-show-sm-only admin-menu" data-am-offcanvas="{target: '#admin-offcanvas'}"></a>

<footer>
  <!-- <hr> -->
  <p class="am-padding-left law">© 2014 Xiaomu.ren, Inc. Licensed under MIT license.</p>
</footer>


</body>
</html>
